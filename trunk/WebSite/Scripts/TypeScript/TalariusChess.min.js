var TalariusChess;(function(n){var h=function(){function n(n,t,f,e,o){this.CanvasWidth=400,this.ChessGame=new i(f,e,t),this.ChessBoardHelper=new u(this.ChessGame),this.HubCom=new r(f,this.ChessBoardHelper,o)}return n}(),i,r,u,f,t,e,o,s;n.Game=h,i=function(){function n(n,t,i){this.Id=0,this.PlayerColor="-",this.ChessBoard=null,this.Stage=null,this.ScoreBoard=null,this.Id=n,this.PlayerColor=t,this.ScoreBoard=document.getElementById(i)}return n}(),n.ChessGame=i,r=function(){function n(n,t,i){this.ChessBoardHelper=t,this.Hub=$.connection.hub,this.Hub.state.userId=i;var r=this;this.Hub.proxies.chesshub.client.displayGameStatus=function(n){r.ChessBoardHelper.setGameStatus(n)},$.connection.hub.start().done(function(){r.Hub.proxies.chesshub.server.get(n)})}return n.prototype.sendMoveToServer=function(){this.Hub.server.move(this.ChessBoardHelper.ChessGame.Id,this.ChessBoardHelper.ChessGame.ChessBoard.ActiveColor,this.ChessBoardHelper.ChessGame.CurrentMove.StartSquare,this.ChessBoardHelper.ChessGame.CurrentMove.EndSquare)},n.prototype.sendPromotionMoveToServer=function(n,t,i,r,u){this.Hub.server.promote(n,t,i,r,u)},n}(),n.HubCom=r,u=function(){function n(n){this.SquareSize=50,this.PieceSize=0,this.BlackOnBottom=!1,$("#statusBar").hide(),this.ChessGame=n,this.PieceSize=Math.floor(this.SquareSize*.95),this.Drawing=new e(this.ChessGame,this.SquareSize,this.PieceSize),this.Conversion=new f(this.SquareSize)}return n.prototype.onDragStart=function(n,t){var i=n.userPosition.x,r=n.userPosition.y;this.validateMoveBegin(n,i,r,t)},n.prototype.onDragEnd=function(n){var t=n.userPosition.x,i=n.userPosition.y;this.validateMoveEnd(t,i)},n.prototype.setGameStatus=function(n){this.refreshBoard(n),n.ChessBoard.MoveSuccess||t.custom(n.ChessBoard.MoveFailureMessage)},n.prototype.refreshBoard=function(n){n.CurrentMove=new s(null,null),this.Drawing.drawBoard(n,this.onDragStart,this.onDragEnd)},n.prototype.validateMoveBegin=function(n,i,r){var u=this.ChessGame.PlayerColor==this.ChessGame.ChessBoard.ActiveColor;u?this.ChessGame.CurrentMove.StartSquare=this.Conversion.getSquareFromMousePosition(i,r):(this.ChessGame.CurrentMove.StartSquare=null,t.itIsNotYourTurn())},n.prototype.validateMoveEnd=function(n,i){if(this.ChessGame.CurrentMove.EndSquare=this.Conversion.getSquareFromMousePosition(n,i),!this.ChessGame.CurrentMove.isValid()){this.refreshBoard(this.ChessGame.ChessBoard),t.invalidMove();return}var r=this.isThisAPawnPromotion(this.ChessGame.ChessBoard.ActiveColor,this.ChessGame.ChessBoard.Matrix,this.ChessGame.CurrentMove.StartSquare,this.ChessGame.CurrentMove.EndSquare),r=this.isThisAPawnPromotion(this.ChessGame.ChessBoard.ActiveColor,this.ChessGame.ChessBoard.Matrix,this.ChessGame.CurrentMove.StartSquare,this.ChessGame.CurrentMove.EndSquare)},n.prototype.isThisAPawnPromotion=function(n,t,i,r){var o=this.Conversion.squareToPosition(i),u=this.Conversion.squareToPosition(r),f=!1,e;return(n=="w"&&u>=56&&u<=63?f=!0:n=="b"&&u>=0&&u<=7&&(f=!0),f&&(e=t[o],e.toUpperCase()=="P"))?!0:!1},n.prototype.showPawnPromotionDialog=function(n,t,i,r){var u="Game.HubCom.sendPromotionMoveToServer('"+n+"', '"+t+"', '"+i+"', '"+r+"', '[[piece]]')",f=u.replace("[[piece]]","q"),e=u.replace("[[piece]]","n"),o="<div>Choose the piece you'd like: <button onclick=\""+f+'">Queen<\/button> <button onclick="'+e+'">Knight<\/button><\/div>'},n}(),n.ChessBoardHelper=u,f=function(){function n(n){this.SquareSize=n}return n.prototype.getSquareFromMousePosition=function(n,t){var i=this.roundDown(Math.floor(n)),r=this.roundDown(Math.floor(t));return this.findSquare(i,r,this.SquareSize)},n.prototype.findSquare=function(n,t,i){var r=8-t/i,u=n/i+1;return this.convertFileToLetter(u)+r.toString()},n.prototype.convertFileToLetter=function(n){return String.fromCharCode(64+n).toLowerCase()},n.prototype.roundDown=function(n){if(n){var t=+(n/this.SquareSize);return t*this.SquareSize}return n},n.prototype.squareToPosition=function(n){var t=this.convertLetterToFile(n[0]),i=n[1];return(i-1)*8+(t-1)},n.prototype.convertLetterToFile=function(n){var t=0;switch(n){case"a":t=1;break;case"b":t=2;break;case"c":t=3;break;case"d":t=4;break;case"e":t=5;break;case"f":t=6;break;case"g":t=7;break;case"h":t=8}return t},n}(),n.Conversion=f,t=function(){function n(){}return n.custom=function(n){n&&alert(n)},n.invalidMove=function(){alert("Invalid move, try again.")},n.itIsNotYourTurn=function(){alert("Please wait for your opponent to move before you move again.")},n}(),n.Messages=t,e=function(){function n(n,t,i){this.SquareSize=0,this.PieceSize=0,this.CanvasWidth=0,this.SquareSize=n,this.PieceSize=t,this.CanvasWidth=i}return n.prototype.drawImage=function(n,t){var u=this.getImageName(t),i=this.findPosition(n),r=this.SquareSize-this.PieceSize,e=i[0]+r,s=i[1]+r,f=this.getPieceSource(u);return new o(f,this.PieceSize,this.PieceSize)},n.prototype.drawBoard=function(n,t,i){var u,f;n.Stage.clear();var e=0,o=0,r=!1,s="";for(u=0;u<8;u++){for(f=0;f<8;f++)s=r?"rgb(71,71,71)":"white",e=this.SquareSize*f,o=this.SquareSize*u,r=r?!1:!0;r=r?!1:!0}this.drawPieces(n,t,i),this.setScoreBoard(n.PlayerColor,n.ChessBoard.ActiveColor,n.ChessBoard.FEN,n.ChessBoard.PGN),n.Stage.draw()},n.prototype.setScoreBoard=function(n,t,i,r){var f=n==t?!0:!1,e='<span id="moveIndicator">'+(t=="w"?"White's move":"Black's move")+(f?" - You're up!":"")+"<\/span>",o="<span>"+i+"<\/span>",u="";r&&(u="<span>"+r+"<\/span>"),$("#MoveIndicator").html(e),$("#FEN").html(o),$("#PGN").html(u+'<br clear="both" />'),$("#statusBar").show()},n.prototype.drawPieces=function(n,t,i){var u=n.ChessBoard.Matrix,r;for(r in u)var f=+r,e=u[r],o=this.drawImage(f,e,t,i)},n.prototype.getPieceSource=function(n){return"/Images/Pieces/"+n+".png"},n.prototype.getImageName=function(n){var i=this.isUpperCase(n)?"White":"Black",r=n.toUpperCase(),t="Pawn";switch(r){case"R":t="Rook";break;case"N":t="Knight";break;case"B":t="Bishop";break;case"Q":t="Queen";break;case"K":t="King"}return i+t},n.prototype.findPosition=function(n){var t=+(n/8)+1,i=n%8+1,r=this.CanvasWidth-t*this.SquareSize,u=(i-1)*this.SquareSize;return[u,r]},n.prototype.isUpperCase=function(n){return n==n.toUpperCase()},n}(),n.Drawing=e,o=function(){function n(n,t,i){this.Rotation=0,this.Image=new Image,t||(this.Width=this.Image.width),i||(this.Height=this.Image.height),this.Url=n}return n.prototype.rotate=function(n){this.Rotation+=n,this.Rotation>360&&(this.Rotation=Math.abs(this.Rotation-360))},n.prototype.load=function(){this.Image.onload=function(){this.shape.redraw(),this.image.onload()},this.Image.src=this.getRoot()+this.Url},n.prototype.getRoot=function(){var n=window.location.protocol+"//"+window.location.host,t,i;return n.indexOf("localhost")>=0?n.indexOf(":")>=0?n:(t=window.location.pathname.split("/"),i=t[1],n+"/"+i):n},n}(),n.GameImage=o,s=function(){function n(n,t){this.StartSquare="",this.EndSquare="",this.StartSquare=n,this.EndSquare=t}return n.prototype.isValid=function(){return!this.StartSquare||!this.EndSquare},n}(),n.Move=s})(TalariusChess||(TalariusChess={}))